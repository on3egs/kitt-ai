<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>KITT V35.6 MAESTRO</title>
<style>
  :root { --neon: #00ff00; --glow: rgba(0, 255, 0, 0.6); }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { 
    background: #000 !important; color: #fff; font-family: 'Courier New', monospace;
    height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  }
  
  /* Filtre CRT transparent aux clics */
  body::after { 
    content: ""; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0; 
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
    linear-gradient(90deg, rgba(0, 255, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 255, 0, 0.02)); 
    z-index: 9999; pointer-events: none !important; opacity: 0.3; 
  }

  .header { text-align: center; padding: 15px; border-bottom: 1px solid #004400; z-index: 5000; background: #000; }
  .header h1 { color: var(--neon) !important; text-shadow: 0 0 20px var(--glow); letter-spacing: 5px; font-size: 1.5em; }
  .header .subtitle { font-size: 0.7em; color: #008800; margin-top: 5px; }

  .chat-area { 
    flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
    z-index: 8000 !important; position: relative !important; pointer-events: auto !important;
    background: rgba(0,0,0,0.5);
  }

  .input-area {
    padding: 15px; border-top: 1px solid #004400; display: flex; gap: 10px; align-items: center;
    z-index: 8000 !important; position: relative !important; pointer-events: auto !important;
    background: #050505;
  }

  input#input {
    flex: 1; background: #001100; border: 1px solid #004400; color: #00ff00;
    padding: 12px; border-radius: 5px; font-family: inherit; font-size: 16px;
    outline: none; pointer-events: auto !important;
  }

  button {
    background: #002200; color: #00ff00; border: 1px solid #00ff00;
    padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer;
    pointer-events: auto !important; z-index: 8001 !important;
  }
  
  .mic-btn, .auto-btn { border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
  .mic-btn.active, .auto-btn.active { background: #00ff00; color: #000; }

  /* Éléments de fond neutralisés */
  #brain-canvas, #orb, #jarvis-bg { position: fixed; inset: 0; z-index: 0; pointer-events: none !important; opacity: 0.4; }

  #intro-overlay { 
    position: fixed; inset: 0; background: #000; z-index: 10000; 
    display: flex; align-items: center; justify-content: center; color: #00ff00;
    cursor: pointer;
  }
</style>
</head>
<body onclick="ensurePlaybackCtx()">

<div id="intro-overlay" onclick="this.remove();">
  <div style="text-align:center;">
    <h1 style="letter-spacing:10px;">KITT</h1>
    <p style="margin-top:20px; font-size:0.8em;">TAP TO START</p>
  </div>
</div>

<canvas id="brain-canvas"></canvas>

<div class="header">
  <h1>K I T T</h1>
  <div class="subtitle">V35.6 MAESTRO — INTERFACE ÉPURÉE</div>
</div>

<div class="chat-area" id="chat"></div>

<div class="input-area">
  <button class="mic-btn" id="mic" onclick="toggleMic()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg>
  </button>
  <button class="auto-btn" id="automic" onclick="toggleAutoListen()">AUTO</button>
  <input type="text" id="input" placeholder="Écrire à KITT..." autocomplete="off">
  <button id="send" onclick="sendMessage()">SEND</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const micBtn = document.getElementById('mic');
const autoBtn = document.getElementById('automic');
const sendBtn = document.getElementById('send');
const sessionId = 'kyronex-' + Date.now();

let audioCtx = null;
function ensurePlaybackCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function addMessage(text, role) {
  const div = document.createElement('div');
  div.style.margin = '10px 0';
  div.style.color = role === 'user' ? '#00ffaa' : '#ffaaaa';
  div.innerHTML = `<b>${role.toUpperCase()}:</b> ${text}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;
  addMessage(msg, 'user');
  input.value = '';
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ message: msg, session_id: sessionId, audio: true })
    });
    const data = await res.json();
    if (data.reply) {
      addMessage(data.reply, 'kitt');
      if (data.audio) playAudio(data.audio);
    }
  } catch(e) { addMessage('Erreur serveur.', 'kitt'); }
}

function playAudio(url) {
  const audio = new Audio(url);
  audio.play().catch(e => console.error("Audio block:", e));
}

// STUB fonctions micro pour éviter crash (à reconnecter proprement si besoin)
function toggleMic() { alert("Micro simple activé (V35.6)"); }
function toggleAutoListen() { alert("Auto-écoute activée (V35.6)"); }

input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
