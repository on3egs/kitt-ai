<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>KITT — V36.1 PERFECT LAYOUT</title>
<style>
  :root { --red: #ff0000; --red-glow: rgba(255, 0, 0, 0.6); }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { 
    background: #000 !important; color: #fff; font-family: 'Courier New', monospace;
    height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  }
  
  /* Filtre CRT Maestro */
  body::after { 
    content: ""; display: block; position: fixed; inset: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
    linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02)); 
    z-index: 9999; pointer-events: none !important; opacity: 0.25; 
  }

  /* HEADER & VOICEBOX */
  .header { 
    text-align: center; padding: 10px 10px 5px; 
    border-bottom: 1px solid #220000; z-index: 5000; background: #000;
    position: relative;
  }
  .header h1 { color: var(--red); text-shadow: 0 0 15px var(--red-glow); letter-spacing: 10px; font-size: 1.4em; }
  
  .voicebox-container {
    display: flex; justify-content: center; padding: 5px 0;
  }
  #voicebox { width: 180px; height: 32px; background: rgba(10,0,0,0.8); border: 1px solid #330000; border-radius: 3px; }

  .header-btns {
    display: flex; justify-content: center; gap: 8px; margin: 8px 0; flex-wrap: wrap;
  }
  .header-btns button {
    background: transparent; border: 1px solid #440000; color: #880000;
    font-size: 0.6em; padding: 4px 8px; border-radius: 2px; cursor: pointer;
  }
  .header-btns button.active { color: #ff0000; border-color: #ff0000; box-shadow: 0 0 10px #ff000044; }

  /* SCANNER KI2000 - Juste sous les boutons */
  .scanner-container {
    display: flex; justify-content: center; padding: 8px 0;
    border-bottom: 1px solid #220000; background: #050000; z-index: 4999;
  }
  .scanner {
    width: min(320px, 85vw); height: 10px; background: #110000;
    border-radius: 5px; position: relative; overflow: hidden; border: 1px solid #330000;
  }
  .scanner-trail { position: absolute; top: 0; height: 100%; width: 80px; border-radius: 5px; pointer-events: none; }
  .scanner-head { position: absolute; top: -1px; width: 28px; height: calc(100% + 2px); border-radius: 4px; pointer-events: none; }

  /* CHAT AREA */
  .chat-area { 
    flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
    z-index: 8000 !important; position: relative !important; pointer-events: auto !important;
  }
  .message { max-width: 85%; padding: 8px; font-size: 0.95em; line-height: 1.4; border-radius: 4px; }
  .message.user { align-self: flex-end; color: #8edd8e; border-right: 2px solid #3a9a3a; }
  .message.kitt { align-self: flex-start; color: #ffbcbc; border-left: 2px solid #dd3311; }

  /* INPUT AREA */
  .input-area {
    padding: 12px 15px max(12px, env(safe-area-inset-bottom)); 
    border-top: 1px solid #220000; display: flex; gap: 10px; align-items: center;
    z-index: 8000 !important; position: relative !important; background: #050505;
  }
  input#input {
    flex: 1; background: #0d0000; border: 1px solid #330000; color: #ffaaaa;
    padding: 12px; border-radius: 4px; font-family: inherit; font-size: 16px; outline: none;
  }
  
  .mic-btn, .auto-btn { 
    width: 46px; height: 46px; border-radius: 50%; display: flex; 
    align-items: center; justify-content: center; background: #1a0000; 
    border: 1px solid #440000; color: #ff4444; cursor: pointer;
  }
  .mic-btn.recording { background: #ff0000 !important; color: #fff !important; box-shadow: 0 0 20px #ff0000; }
  .auto-btn.active.waiting { background: #004400 !important; color: #00ff00 !important; border-color: #00ff00; }
  .auto-btn.active.hearing { background: #ff0000 !important; color: #fff !important; box-shadow: 0 0 25px #ff0000; }

  #send-btn { background: #330000; color: #ff0000; border: 1px solid #660000; padding: 10px 15px; border-radius: 4px; font-weight: bold; }

  /* Background elements neutralisés */
  #brain-canvas, #orb, #jarvis-bg, #intro-overlay { position: fixed; inset: 0; z-index: 0; pointer-events: none !important; }
  #intro-overlay { z-index: 10000 !important; background: #000; pointer-events: auto !important; display: flex; align-items: center; justify-content: center; cursor: pointer; }
</style>
</head>
<body onclick="ensurePlaybackCtx()">

<div id="intro-overlay" onclick="this.remove();">
  <div style="text-align:center;">
    <h1 style="letter-spacing:10px; color:#ff0000;">KITT</h1>
    <p style="margin-top:20px; font-size:0.8em; color:#880000;">TAP TO INITIATE</p>
  </div>
</div>

<div class="header">
  <h1>K I T T</h1>
  <div class="voicebox-container">
    <canvas id="voicebox" width="180" height="32"></canvas>
  </div>
  <div class="header-btns">
    <button onclick="location.reload()">RST</button>
    <button id="vig-btn">VIG</button>
    <button id="amb-btn">AMB</button>
    <button id="night-btn">NIGHT</button>
  </div>
</div>

<div class="scanner-container">
  <div class="scanner" id="scanner">
    <div class="scanner-trail" id="scannerTrail"></div>
    <div class="scanner-head" id="scannerHead"></div>
  </div>
</div>

<div class="chat-area" id="chat"></div>

<div class="input-area">
  <button class="mic-btn" id="mic" onclick="toggleMic()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/></svg>
  </button>
  <button class="auto-btn" id="automic" onclick="toggleAutoListen()">AUTO</button>
  <input type="text" id="input" placeholder="Neural Link..." autocomplete="off">
  <button id="send-btn" onclick="sendMessage()">SEND</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const micBtn = document.getElementById('mic');
const autoBtn = document.getElementById('automic');
const scanner = document.getElementById('scanner');
const sessionId = 'kyronex-' + Date.now();

let audioCtx = null;
function ensurePlaybackCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// ── Voicebox Logic (3 Bars) ──
let voiceboxAnalyser = null;
function ensureVoiceboxAnalyser() {
  const ctx = ensurePlaybackCtx();
  if (!voiceboxAnalyser) {
    voiceboxAnalyser = ctx.createAnalyser();
    voiceboxAnalyser.fftSize = 128;
    voiceboxAnalyser.connect(ctx.destination);
  }
  return voiceboxAnalyser;
}

function drawVoicebox() {
  const canvas = document.getElementById('voicebox');
  if (!canvas || !voiceboxAnalyser) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const data = new Uint8Array(voiceboxAnalyser.frequencyBinCount);
  voiceboxAnalyser.getByteFrequencyData(data);
  ctx.clearRect(0, 0, W, H);
  const bW = (W - 24) / 3;
  for (let i = 0; i < 3; i++) {
    const val = data[i * 2] / 255;
    const bH = Math.max(4, val * H * 0.9);
    const x = i * (bW + 12);
    const y = (H - bH) / 2;
    ctx.fillStyle = '#ff0000';
    ctx.shadowBlur = 10; ctx.shadowColor = '#ff0000';
    ctx.fillRect(x, y, bW, bH);
  }
  requestAnimationFrame(drawVoicebox);
}

// ── Scanner Logic ──
(function animateScanner() {
  const head = document.getElementById('scannerHead');
  const trail = document.getElementById('scannerTrail');
  let pos = 0, dir = 1;
  function tick() {
    const max = scanner.offsetWidth - 28;
    pos += dir * (scanner.classList.contains('speaking') ? 4 : 2);
    if (pos >= max) { pos = max; dir = -1; }
    if (pos <= 0) { pos = 0; dir = 1; }
    head.style.left = pos + 'px';
    head.style.background = '#ff0000';
    head.style.boxShadow = '0 0 15px #ff0000';
    trail.style.left = (dir > 0 ? pos - 80 : pos + 28) + 'px';
    trail.style.background = `linear-gradient(${dir > 0 ? '90' : '270'}deg, transparent, #ff000044)`;
    requestAnimationFrame(tick);
  }
  tick();
})();

// ── Communication Logic ──
function addMessage(text, role) {
  const div = document.createElement('div');
  div.className = 'message ' + role;
  div.innerHTML = `<b>${role.toUpperCase()}:</b> ${text}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;
  addMessage(msg, 'user');
  input.value = '';
  scanner.classList.add('speaking');
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ message: msg, session_id: sessionId, audio: true })
    });
    const data = await res.json();
    if (data.reply) {
      addMessage(data.reply, 'kitt');
      if (data.audio) playAudio(data.audio);
    }
  } catch(e) { addMessage('Error.', 'kitt'); }
  finally { scanner.classList.remove('speaking'); }
}

function playAudio(url) {
  ensureVoiceboxAnalyser();
  const audio = new Audio(url);
  const source = audioCtx.createMediaElementSource(audio);
  source.connect(voiceboxAnalyser);
  audio.play();
  drawVoicebox();
}

// ── STT Placeholder (Re-connect properly) ──
function toggleMic() { micBtn.classList.toggle('recording'); }
function toggleAutoListen() { autoBtn.classList.toggle('active'); autoBtn.classList.toggle('waiting'); }

input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
